<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vote Visualisation</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Live Vote VIZZ</h1>

    <!-- Vote Bars -->
    <div class="bar-container">
      <div id="bar-red" class="bar red">
        ðŸ‡¨ðŸ‡¦ðŸ‡ºðŸ‡¸ CAN/U.S. <span class="count" id="count-red">0%</span>
      </div>
    </div>
    <div class="bar-container">
      <div id="bar-blue" class="bar blue">
        ðŸ‡¬ðŸ‡§ UK <span class="count" id="count-blue">0%</span>
      </div>
    </div>
    <div class="bar-container">
      <div id="bar-green" class="bar green">
        ðŸ‡¦ðŸ‡ºðŸ‡³ðŸ‡¿ AUS/NZ <span class="count" id="count-green">0%</span>
      </div>
    </div>
    <div class="bar-container">
      <div id="bar-yellow" class="bar yellow">
        ðŸ‡ªðŸ‡º EURO <span class="count" id="count-yellow">0%</span>
      </div>
    </div>

    <!-- Pie Chart -->
    <svg viewBox="0 0 200 200" class="pie-chart">
      <circle r="80" cx="100" cy="100" class="slice red" id="slice-red"></circle>
      <circle r="80" cx="100" cy="100" class="slice blue" id="slice-blue"></circle>
      <circle r="80" cx="100" cy="100" class="slice green" id="slice-green"></circle>
      <circle r="80" cx="100" cy="100" class="slice yellow" id="slice-yellow"></circle>
    </svg>
  </div>

  <script>
    const votesUrl = 'https://script.google.com/macros/s/AKfycbzv5LQFZ2Dj2x4OMQZr1o20acXoN4DCy8Vez7oxc1A8T0hCGBK5EqHusXWxq7yIgY21Pw/exec';

    async function fetchVotes() {
      try {
        const response = await fetch(votesUrl);
        const votes = await response.json();
        updateVisuals(votes);
      } catch (err) {
        console.error('Vote fetch failed:', err);
      }
    }

    function updateVisuals(votes) {
      const keys = ['votered', 'voteblue', 'votegreen', 'voteyellow'];
      const total = keys.reduce((sum, k) => sum + (votes[k] || 0), 0) || 1;
      let offset = 0;

      keys.forEach((key) => {
        const count = votes[key] || 0;
        const id = key.slice(4);
        const percent = Math.round((count / total) * 100);
        const bar = document.getElementById(`bar-${id}`);
        const countEl = document.getElementById(`count-${id}`);
        const slice = document.getElementById(`slice-${id}`);

        const width = percent + '%';
        if (bar.style.width !== width) {
          bar.classList.remove('blink');
          void bar.offsetWidth;
          bar.classList.add('blink');
        }

        bar.style.width = width;
        countEl.textContent = percent + '%';

        const dash = (percent / 100) * 502;
        slice.setAttribute('stroke-dasharray', `${dash} ${502 - dash}`);
        slice.setAttribute('stroke-dashoffset', -offset);
        offset += dash;
      });
    }

    fetchVotes();
    setInterval(fetchVotes, 10000);
  </script>
</body>
</html>
