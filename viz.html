<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vote Visual</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="bars-section">
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-red" class="bar">ðŸ‡¨ðŸ‡¦ðŸ‡ºðŸ‡¸ CAN/U.S.</div>
          <div id="count-red" class="count">0</div>
        </div>
        <div id="percent-red" class="percentage">0%</div>
      </div>
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-blue" class="bar">ðŸ‡¬ðŸ‡§ UK</div>
          <div id="count-blue" class="count">0</div>
        </div>
        <div id="percent-blue" class="percentage">0%</div>
      </div>
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-green" class="bar">ðŸ‡¦ðŸ‡ºðŸ‡³ðŸ‡¿ AUS/NZ</div>
          <div id="count-green" class="count">0</div>
        </div>
        <div id="percent-green" class="percentage">0%</div>
      </div>
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-yellow" class="bar">ðŸ‡ªðŸ‡º EURO</div>
          <div id="count-yellow" class="count">0</div>
        </div>
        <div id="percent-yellow" class="percentage">0%</div>
      </div>
    </div>

    <div class="pie-section">
      <div id="pie">
        <svg viewBox="0 0 300 300"></svg>
      </div>
    </div>
  </div>

  <script>
    const votesUrl = 'https://script.google.com/macros/s/AKfycbzv5LQFZ2Dj2x4OMQZr1o20acXoN4DCy8Vez7oxc1A8T0hCGBK5EqHusXWxq7yIgY21Pw/exec';

    const bars = {
      red:    { label: 'ðŸ‡¨ðŸ‡¦ðŸ‡ºðŸ‡¸ CAN/U.S.', colors: ['#ff4e50', '#ff7676'] },
      blue:   { label: 'ðŸ‡¬ðŸ‡§ UK',         colors: ['#4a90e2', '#6bb9f0'] },
      green:  { label: 'ðŸ‡¦ðŸ‡ºðŸ‡³ðŸ‡¿ AUS/NZ',   colors: ['#2ecc71', '#58d68d'] },
      yellow: { label: 'ðŸ‡ªðŸ‡º EURO',       colors: ['#f1c40f', '#f9e79f'] }
    };

    let previousCounts = { red: 0, blue: 0, green: 0, yellow: 0 };

    function createGradient(svg, id, colors) {
      const defs = svg.querySelector('defs') || (() => {
        const d = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        svg.appendChild(d);
        return d;
      })();
      let grad = document.getElementById(id);
      if (!grad) {
        grad = document.createElementNS("http://www.w3.org/2000/svg", "radialGradient");
        grad.setAttribute("id", id);
        grad.setAttribute("cx", "50%");
        grad.setAttribute("cy", "50%");
        grad.setAttribute("r", "50%");
        grad.setAttribute("fx", "50%");
        grad.setAttribute("fy", "50%");
        colors.forEach((color, i) => {
          const stop = document.createElementNS("http://www.w3.org/2000/svg", "stop");
          stop.setAttribute("offset", `${i / (colors.length - 1) * 100}%`);
          stop.setAttribute("stop-color", color);
          grad.appendChild(stop);
        });
        defs.appendChild(grad);
      }
      return `url(#${id})`;
    }

    function drawPieChart(data) {
      const svg = document.querySelector("#pie svg");
      svg.innerHTML = '';

      const total = data.reduce((a,b) => a + b, 0) || 1;
      const centerX = 150, centerY = 150, radius = 140;
      let startAngle = 0;

      Object.keys(bars).forEach((key, i) => {
        const value = data[i];
        if (value === 0) return;
        const sliceAngle = (value / total) * 2 * Math.PI;

        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const endAngle = startAngle + sliceAngle;
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);
        const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;

        const pathData = [
          `M ${centerX} ${centerY}`,
          `L ${x1} ${y1}`,
          `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
          'Z'
        ].join(' ');

        const gradId = `grad-${key}`;
        const fill = createGradient(svg, gradId, bars[key].colors);
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", pathData);
        path.setAttribute("fill", fill);
        svg.appendChild(path);

        const midAngle = startAngle + sliceAngle / 2;
        const lx = centerX + radius * 0.65 * Math.cos(midAngle);
        const ly = centerY + radius * 0.65 * Math.sin(midAngle);

        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", lx);
        label.setAttribute("y", ly);
        label.setAttribute("class", "slice-label");
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("alignment-baseline", "middle");
        label.textContent = bars[key].label;
        svg.appendChild(label);

        startAngle = endAngle;
      });
    }

    function updateBars(votes) {
      const keys = ['votered', 'voteblue', 'votegreen', 'voteyellow'];
      const counts = keys.map(k => votes[k] || 0);
      const maxVotes = Math.max(...counts, 1);
      const total = counts.reduce((a,b) => a+b, 0) || 1;

      keys.forEach((key, i) => {
        const short = key.slice(4);
        const count = counts[i];
        const bar = document.getElementById('bar-' + short);
        const countElem = document.getElementById('count-' + short);
        const percentElem = document.getElementById('percent-' + short);

        const widthPercent = (count / maxVotes) * 100;
        bar.style.width = widthPercent + '%';
        countElem.textContent = count;
        percentElem.textContent = Math.round((count / total) * 100) + '%';

        if (count > previousCounts[short]) {
          bar.classList.remove('blink');
          void bar.offsetWidth;
          bar.classList.add('blink');
        }
        previousCounts[short] = count;
      });

      drawPieChart(counts);
    }

    async function fetchVotes() {
      try {
        const response = await fetch(votesUrl);
        const data = await response.json();
        updateBars(data);
      } catch (e) {
        console.error("Vote fetch error", e);
      }
    }

    fetchVotes();
    setInterval(fetchVotes, 2000);
  </script>
</body>
</html>
