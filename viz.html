<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vote Vizz</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 700px;
      height: 700px;
      display: grid;
      grid-template-rows: 50% 50%;
    }

    .bars-section {
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      padding: 10px;
    }

    .bar-wrapper {
      display: flex;
      align-items: center;
      height: 20%;
    }

    .bar-container {
      flex: 1;
      height: 100%;
      background: #ccc;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
    }

    .bar {
      height: 100%;
      transition: width 0.8s ease;
      display: flex;
      align-items: center;
      padding-left: 10px;
      color: #fff;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
      font-size: 13px;
    }

    #bar-red {
      background: linear-gradient(90deg, #ff4e50, #ff7676);
    }
    #bar-blue {
      background: linear-gradient(90deg, #4a90e2, #6bb9f0);
    }
    #bar-green {
      background: linear-gradient(90deg, #2ecc71, #58d68d);
    }
    #bar-yellow {
      background: linear-gradient(90deg, #f1c40f, #f9e79f);
      color: #000;
      text-shadow: none;
    }

    .count {
      position: absolute;
      right: 8px;
      font-weight: bold;
      color: #fff;
    }

    .percentage {
      width: 40px;
      text-align: right;
      margin-left: 6px;
      font-weight: bold;
      font-size: 13px;
    }

    .pie-section {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #pie-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      width: calc(100% - 40px) !important;
      height: auto !important;
      max-height: calc(100% - 40px) !important;
      aspect-ratio: 1 / 1;
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="bars-section">
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-red" class="bar">ðŸ‡¨ðŸ‡¦ðŸ‡ºðŸ‡¸ CAN/U.S.</div>
          <div id="count-red" class="count">0</div>
        </div>
        <div id="percent-red" class="percentage">0%</div>
      </div>
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-blue" class="bar">ðŸ‡¬ðŸ‡§ UK</div>
          <div id="count-blue" class="count">0</div>
        </div>
        <div id="percent-blue" class="percentage">0%</div>
      </div>
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-green" class="bar">ðŸ‡¦ðŸ‡ºðŸ‡³ðŸ‡¿ AUS/NZ</div>
          <div id="count-green" class="count">0</div>
        </div>
        <div id="percent-green" class="percentage">0%</div>
      </div>
      <div class="bar-wrapper">
        <div class="bar-container">
          <div id="bar-yellow" class="bar">ðŸ‡ªðŸ‡º EURO</div>
          <div id="count-yellow" class="count">0</div>
        </div>
        <div id="percent-yellow" class="percentage">0%</div>
      </div>
    </div>

    <div class="pie-section">
      <div id="pie-container">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const votesUrl = 'https://script.google.com/macros/s/AKfycbzv5LQFZ2Dj2x4OMQZr1o20acXoN4DCy8Vez7oxc1A8T0hCGBK5EqHusXWxq7yIgY21Pw/exec';
    const keys = ['votered', 'voteblue', 'votegreen', 'voteyellow'];

    const bars = {
      red:    { label: 'ðŸ‡¨ðŸ‡¦ðŸ‡ºðŸ‡¸ CAN/U.S.', color: ['#ff4e50', '#ff7676'] },
      blue:   { label: 'ðŸ‡¬ðŸ‡§ UK',         color: ['#4a90e2', '#6bb9f0'] },
      green:  { label: 'ðŸ‡¦ðŸ‡ºðŸ‡³ðŸ‡¿ AUS/NZ',   color: ['#2ecc71', '#58d68d'] },
      yellow: { label: 'ðŸ‡ªðŸ‡º EURO',       color: ['#f1c40f', '#f9e79f'] }
    };

    const ctx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.values(bars).map(b => b.label),
        datasets: [{
          data: [0, 0, 0, 0],
          backgroundColor: [],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        animation: {
          animateRotate: true,
          animateScale: true
        },
        plugins: {
          legend: {
            display: false
          }
        }
      },
      plugins: [{
        id: 'gradientFills',
        beforeDraw(chart) {
          const {ctx, chartArea} = chart;
          const gradients = Object.values(bars).map(bar => {
            const grad = ctx.createRadialGradient(
              chartArea.width / 2, chartArea.height / 2, 0,
              chartArea.width / 2, chartArea.height / 2, chartArea.width / 2
            );
            grad.addColorStop(0, bar.color[0]);
            grad.addColorStop(1, bar.color[1]);
            return grad;
          });
          chart.data.datasets[0].backgroundColor = gradients;
        }
      }]
    });

    async function fetchVotes() {
      try {
        const response = await fetch(votesUrl);
        if (!response.ok) throw new Error('Network response was not ok');
        const votes = await response.json();
        updateBars(votes);
        updatePie(votes);
      } catch (error) {
        console.error('Error fetching votes:', error);
      }
    }

    function updateBars(votes) {
      const counts = keys.map(k => votes[k] || 0);
      const total = counts.reduce((sum, val) => sum + val, 0);
      const maxVotes = Math.max(...counts, 1);

      keys.forEach((key, i) => {
        const short = key.slice(4);
        const count = votes[key] || 0;
        const percent = total > 0 ? Math.round((count / total) * 100) : 0;

        document.getElementById('bar-' + short).style.width = (count / maxVotes) * 100 + '%';
        document.getElementById('count-' + short).textContent = count;
        document.getElementById('percent-' + short).textContent = percent + '%';
      });
    }

    function updatePie(votes) {
      const data = keys.map(k => votes[k] || 0);
      pieChart.data.datasets[0].data = data;
      pieChart.update();
    }

    fetchVotes();
    setInterval(fetchVotes, 10000);
  </script>
</body>
</html>
